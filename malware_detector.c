#include <stdio.h>
#include <string.h>
#include "malware_detector.h"

void detect_malware(const char *log_message) {
    printf("Checking for malware in log message: %s\n", log_message);

    // Define malware patterns and corresponding messages
    const char *malware_patterns[][2] = {
        // Ransomware patterns
        {"ransom", "Potential ransomware detected"},
        {"encrypt", "Encryption activity detected, possible ransomware"},
        {"decrypt", "Decryption activity detected, possible ransomware"},
        {"bitlocker", "BitLocker detected, potential ransomware action"},

        // Trojan patterns
        {"trojan", "Trojan malware detected"},
        {"backdoor", "Backdoor detected in the system"},
        {"remote access tool", "Remote access tool detected"},

        // Virus patterns
        {"infect", "Virus infection attempt detected"},
        {"worm", "Worm-like behavior detected"},

        // Spyware patterns
        {"keylogger", "Keylogger activity detected"},
        {"spy", "Spyware activity detected"},
        {"data exfiltration", "Possible data exfiltration detected"},

        // Rootkit patterns
        {"rootkit", "Rootkit detected"},
        {"hidden process", "Hidden process detected, potential rootkit"},

        // Botnet patterns
        {"botnet", "Botnet activity detected"},
        {"command and control", "C2 server communication detected"},
        {"DDoS", "Distributed Denial of Service attack detected"}
    };

    int malware_pattern_count = sizeof(malware_patterns) / sizeof(malware_patterns[0]);

    for (int i = 0; i < malware_pattern_count; i++) {
        if (strstr(log_message, malware_patterns[i][0]) != NULL) {
            printf("%s: %s\n", malware_patterns[i][1], log_message);
            return;
        }
    }

    printf("No malware detected: %s\n", log_message);
}

void scan_for_malware(const char *log_file) {
    FILE *file = fopen(log_file, "r");
    if (file == NULL) {
        perror("Failed to open log file for malware scanning");
        return;
    }

    char line[1024];
    while (fgets(line, sizeof(line), file)) {
        detect_malware(line);
    }

    if (fclose(file) != 0) {
        perror("Failed to close log file after malware scanning");
    }
}
